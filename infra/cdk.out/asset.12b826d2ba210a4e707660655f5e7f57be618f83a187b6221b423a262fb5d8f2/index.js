"use strict";var k=Object.create;var f=Object.defineProperty;var B=Object.getOwnPropertyDescriptor;var D=Object.getOwnPropertyNames;var $=Object.getPrototypeOf,x=Object.prototype.hasOwnProperty;var H=(t,e)=>{for(var n in e)f(t,n,{get:e[n],enumerable:!0})},O=(t,e,n,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of D(e))!x.call(t,s)&&s!==n&&f(t,s,{get:()=>e[s],enumerable:!(r=B(e,s))||r.enumerable});return t};var P=(t,e,n)=>(n=t!=null?k($(t)):{},O(e||!t||!t.__esModule?f(n,"default",{value:t,enumerable:!0}):n,t)),U=t=>O(f({},"__esModule",{value:!0}),t);var Y={};H(Y,{handler:()=>q});module.exports=U(Y);var v=require("@aws-sdk/client-dynamodb"),c=require("@aws-sdk/lib-dynamodb"),h=P(require("crypto")),m=c.DynamoDBDocumentClient.from(new v.DynamoDBClient({})),M=process.env.COMMITS_TABLE,y=process.env.REPOINFO_TABLE,T=process.env.GITHUB_WEBHOOK_SECRET||"",E=process.env.GITHUB_ACCESS_TOKEN||"",I=Number(process.env.CF_WATTS??65),G=Number(process.env.CF_G_PER_KWH??400),C=t=>String(t).padStart(2,"0"),R=(t=new Date)=>`${t.getUTCFullYear()}-${C(t.getUTCMonth()+1)}-${C(t.getUTCDate())}`;function g(t,e){return{statusCode:t,headers:{"Content-Type":"application/json","Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"POST,OPTIONS","Access-Control-Allow-Headers":"Content-Type,X-GitHub-Event,X-Hub-Signature-256,X-GitHub-Delivery,X-CloudGuardian-Rebuild"},body:typeof e=="string"?e:JSON.stringify(e)}}function w(t,e){let n=t.headers||{};return n[e]??n[e.toLowerCase()]}function F(t){return t.isBase64Encoded?Buffer.from(t.body||"","base64"):typeof t.body=="string"?Buffer.from(t.body,"utf8"):Buffer.from(JSON.stringify(t.body||{}),"utf8")}function K(t,e){if(!t||!T)return!1;let n=Buffer.from("sha256="+h.default.createHmac("sha256",T).update(e).digest("hex"),"utf8"),r=Buffer.from(t,"utf8");return r.length===n.length&&h.default.timingSafeEqual(r,n)}function L(t){if(typeof t.run_duration_ms=="number")return t.run_duration_ms;let e=t.created_at?Date.parse(t.created_at):NaN,n=t.updated_at?Date.parse(t.updated_at):NaN;return!Number.isNaN(e)&&!Number.isNaN(n)&&n>e?n-e:0}function j(t,e=I,n=G){let r=e/1e3*(t/36e5)*n;return Math.max(0,Math.round(r*1e3))}async function S(t,e){if(!e||Number.isNaN(e))return;let n=new Date().toISOString(),r=R();await m.send(new c.UpdateCommand({TableName:y,Key:{pk:t,sk:"stats#overall"},UpdateExpression:"ADD #c :v SET #u=:u, #id=:id",ExpressionAttributeNames:{"#c":"carbon_mg_total","#u":"updated_at","#id":"id"},ExpressionAttributeValues:{":v":e,":u":n,":id":t}})),await m.send(new c.UpdateCommand({TableName:y,Key:{pk:t,sk:`stats#${r}`},UpdateExpression:"ADD #c :v SET #u=:u, #id=:id",ExpressionAttributeNames:{"#c":"carbon_mg_day","#u":"updated_at","#id":"id"},ExpressionAttributeValues:{":v":e,":u":n,":id":t}}))}function A(){let t={"User-Agent":"cloudguardian-bot",Accept:"application/vnd.github+json"};return E&&(t.Authorization=`Bearer ${E}`),t}async function z(t,e){let n=e==="Organization"?`https://api.github.com/orgs/${t}/repos`:`https://api.github.com/users/${t}/repos`,r=[],s=1;for(;;){let a=`${n}?per_page=100&page=${s}`,u=await fetch(a,{headers:A()});if(!u.ok)break;let o=await u.json();if(!o.length)break;for(let i of o)r.push({full_name:i.full_name,private:i.private,archived:i.archived});if(o.length<100)break;s++}return r}async function W(t,e){let n=await fetch(`https://api.github.com/repos/${t}/${e}/languages`,{headers:A()});if(!n.ok)return{};let r=await n.json(),s={};for(let[a,u]of Object.entries(r)){let o=Number(u);Number.isNaN(o)||(s[a]=o)}return s}async function p(t,e,n){await m.send(new c.UpdateCommand({TableName:y,Key:{pk:t,sk:e},UpdateExpression:"SET #l=:l, #u=:u, #id=:id",ExpressionAttributeNames:{"#l":"languages_bytes","#u":"updated_at","#id":"id"},ExpressionAttributeValues:{":l":n,":u":new Date().toISOString(),":id":t}}))}function X(t,e){for(let[n,r]of Object.entries(e))t[n]=(t[n]||0)+(r||0);return t}async function J(t,e,n){let r=[],s=0,a=0;return new Promise(u=>{let o=()=>{if(s>=t.length&&a===0)return u(r);for(;a<e&&s<t.length;){let i=s++;a++,n(t[i]).then(d=>{r[i]=d,a--,o()}).catch(()=>{r[i]=void 0,a--,o()})}};o()})}async function V(t,e){let n=await z(t,e),r=R(),s=await J(n,5,async o=>{if(!o||o.archived)return{repo:o?.full_name??"",langs:{}};let[i,d]=o.full_name.split("/"),l=await W(i,d);return{repo:o.full_name,langs:l}}),a={};for(let o of s){if(!o||!o.repo)continue;let i=`repo#${o.repo}`;await p(i,"stats#overall",o.langs),await p(i,`stats#${r}`,o.langs),X(a,o.langs)}let u=`owner#${t}`;return await p(u,"stats#overall",a),await p(u,`stats#${r}`,a),{repoCount:n.length,langsKeys:Object.keys(a).length}}var q=async t=>{if(t.requestContext?.http?.method==="OPTIONS")return g(200,{ok:!0});let e=F(t),n=w(t,"X-Hub-Signature-256"),r=w(t,"X-GitHub-Event")||"",s=w(t,"X-CloudGuardian-Rebuild");if(!K(n,e))return g(401,{error:"invalid signature"});let a=JSON.parse(e.toString("utf8"));if(r==="ping")return g(200,{pong:!0});let u=a.repository||{},o=u.full_name||"unknown/unknown",i=u.owner?.login||o.split("/")[0]||"unknown",d=u.owner?.type==="Organization"?"Organization":"User",l;if((s==="all"||r==="push"||r==="workflow_run")&&(l=await V(i,d)),r==="workflow_run"){let _=a.workflow_run||{},N=L(_),b=j(N);await S(`repo#${o}`,b),await S(`owner#${i}`,b),await m.send(new c.PutCommand({TableName:M,Item:{pk:o,sk:`workflow#${_.id??Date.now()}`,type:"event",payload:{duration_ms:N,mg:b},received_at:new Date().toISOString()}}))}return g(200,{ok:!0,evt:r,owner:i,refreshed:l})};0&&(module.exports={handler});
