"use strict";var x=Object.create;var f=Object.defineProperty;var N=Object.getOwnPropertyDescriptor;var v=Object.getOwnPropertyNames;var H=Object.getPrototypeOf,I=Object.prototype.hasOwnProperty;var R=(t,e)=>{for(var n in e)f(t,n,{get:e[n],enumerable:!0})},E=(t,e,n,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of v(e))!I.call(t,s)&&s!==n&&f(t,s,{get:()=>e[s],enumerable:!(r=N(e,s))||r.enumerable});return t};var U=(t,e,n)=>(n=t!=null?x(H(t)):{},E(e||!t||!t.__esModule?f(n,"default",{value:t,enumerable:!0}):n,t)),K=t=>E(f({},"__esModule",{value:!0}),t);var j={};R(j,{handler:()=>X});module.exports=K(j);var k=require("@aws-sdk/client-dynamodb"),a=require("@aws-sdk/lib-dynamodb"),w=U(require("crypto")),g=a.DynamoDBDocumentClient.from(new k.DynamoDBClient({})),S=process.env.COMMITS_TABLE,l=process.env.REPOINFO_TABLE,T=process.env.GITHUB_WEBHOOK_SECRET||"",h=process.env.GITHUB_ACCESS_TOKEN||"",P=Number(process.env.CF_WATTS??65),$=Number(process.env.CF_G_PER_KWH??400);function i(t,e){return{statusCode:t,headers:{"Content-Type":"application/json","Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"POST,OPTIONS","Access-Control-Allow-Headers":"Content-Type,X-GitHub-Event,X-Hub-Signature-256,X-GitHub-Delivery"},body:typeof e=="string"?e:JSON.stringify(e)}}function m(t,e){let n=t.headers||{};return n[e]??n[e.toLowerCase()]}function G(t){return t.isBase64Encoded?Buffer.from(t.body||"","base64"):typeof t.body=="string"?Buffer.from(t.body,"utf8"):Buffer.from(JSON.stringify(t.body||{}),"utf8")}function M(t,e){if(!t||!T)return!1;let n=Buffer.from("sha256="+w.default.createHmac("sha256",T).update(e).digest("hex"),"utf8"),r=Buffer.from(t,"utf8");return r.length===n.length&&w.default.timingSafeEqual(r,n)}function B(t=new Date){let e=n=>String(n).padStart(2,"0");return`${t.getUTCFullYear()}-${e(t.getUTCMonth()+1)}-${e(t.getUTCDate())}`}async function A(t,e){let n=`https://api.github.com/repos/${t}/${e}/languages`,r={"User-Agent":"cloudguardian-bot",Accept:"application/vnd.github+json"};h&&(r.Authorization=`Bearer ${h}`);let s=await fetch(n,{headers:r});return s.ok?await s.json():(console.warn("languages API failed",s.status,await s.text()),{})}function L(t){let e=Math.max(0,t)/36e5,n=P/1e3*e;return Math.round(n*$)}async function C(t,e){await g.send(new a.UpdateCommand({TableName:l,Key:{pk:t,sk:"stats#overall"},UpdateExpression:"SET #l = :languages, #u = :updated, #repo = :r",ExpressionAttributeNames:{"#l":"languages_bytes","#u":"updated_at","#repo":"repo"},ExpressionAttributeValues:{":languages":e,":updated":new Date().toISOString(),":r":t}}));let n=B();await g.send(new a.UpdateCommand({TableName:l,Key:{pk:t,sk:`stats#${n}`},UpdateExpression:"SET #l = :languages, #u = :updated, #repo = :r",ExpressionAttributeNames:{"#l":"languages_bytes","#u":"updated_at","#repo":"repo"},ExpressionAttributeValues:{":languages":e,":updated":new Date().toISOString(),":r":t}}))}async function W(t,e){let n=B();await g.send(new a.UpdateCommand({TableName:l,Key:{pk:t,sk:"stats#overall"},UpdateExpression:"ADD #c :g SET #u = :updated, #repo = :r",ExpressionAttributeNames:{"#c":"carbon_grams_total","#u":"updated_at","#repo":"repo"},ExpressionAttributeValues:{":g":e,":updated":new Date().toISOString(),":r":t}})),await g.send(new a.UpdateCommand({TableName:l,Key:{pk:t,sk:`stats#${n}`},UpdateExpression:"ADD #cd :g SET #u = :updated, #repo = :r",ExpressionAttributeNames:{"#cd":"carbon_grams_day","#u":"updated_at","#repo":"repo"},ExpressionAttributeValues:{":g":e,":updated":new Date().toISOString(),":r":t}}))}async function O(t,e,n,r){await g.send(new a.PutCommand({TableName:t,Item:{pk:e,sk:n,type:"event",payload:r,received_at:new Date().toISOString()}}))}var X=async t=>{try{if(t.requestContext?.http?.method==="OPTIONS")return i(200,{ok:!0});let e=G(t),n=m(t,"X-Hub-Signature-256"),r=m(t,"X-GitHub-Event")||"",s=m(t,"X-GitHub-Delivery")||"";if(!M(n,e))return i(401,{error:"invalid signature"});let c=JSON.parse(e.toString("utf8"));if(r==="ping")return i(200,{pong:!0});let u=(c.repository||{}).full_name||"unknown/unknown",[b,y]=u.split("/");if(r==="push"){let p=await A(b,y);return await C(u,p),await O(S,u,`push#${Date.now()}`,{delivery:s,head:c.head_commit?.id,commits:(c.commits||[]).map(o=>o.id)}),i(200,{ok:!0,updated_languages:Object.keys(p).length})}if(r==="workflow_run"){let p=c.action||"",o=c.workflow_run||{},_=Number(o.run_duration_ms??0),d=L(_);!isNaN(d)&&d>0&&await W(u,d);let D=await A(b,y);return await C(u,D),await O(S,u,`workflow#${o.id??Date.now()}`,{delivery:s,action:p,event:o.event,status:o.status,conclusion:o.conclusion,duration_ms:_,grams_estimated:d}),i(200,{ok:!0,carbon_g_added:d,event:o.event||null})}return i(200,{ok:!0,ignored_event:r})}catch(e){return console.error("Unhandled error",e),i(500,{error:"internal",message:e?.message||"unknown"})}};0&&(module.exports={handler});
