"use strict";var k=Object.create;var f=Object.defineProperty;var B=Object.getOwnPropertyDescriptor;var x=Object.getOwnPropertyNames;var $=Object.getPrototypeOf,D=Object.prototype.hasOwnProperty;var H=(t,e)=>{for(var n in e)f(t,n,{get:e[n],enumerable:!0})},T=(t,e,n,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of x(e))!D.call(t,s)&&s!==n&&f(t,s,{get:()=>e[s],enumerable:!(r=B(e,s))||r.enumerable});return t};var P=(t,e,n)=>(n=t!=null?k($(t)):{},T(e||!t||!t.__esModule?f(n,"default",{value:t,enumerable:!0}):n,t)),U=t=>T(f({},"__esModule",{value:!0}),t);var Y={};H(Y,{handler:()=>q});module.exports=U(Y);var A=require("@aws-sdk/client-dynamodb"),c=require("@aws-sdk/lib-dynamodb"),h=P(require("crypto")),m=c.DynamoDBDocumentClient.from(new A.DynamoDBClient({})),I=process.env.COMMITS_TABLE,y=process.env.REPOINFO_TABLE,E=process.env.GITHUB_WEBHOOK_SECRET||"",C=process.env.GITHUB_ACCESS_TOKEN||"",G=Number(process.env.CF_WATTS??65),F=Number(process.env.CF_G_PER_KWH??400),S=t=>String(t).padStart(2,"0"),N=(t=new Date)=>`${t.getUTCFullYear()}-${S(t.getUTCMonth()+1)}-${S(t.getUTCDate())}`;function g(t,e){return{statusCode:t,headers:{"Content-Type":"application/json","Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"POST,OPTIONS","Access-Control-Allow-Headers":"Content-Type,X-GitHub-Event,X-Hub-Signature-256,X-GitHub-Delivery,X-CloudGuardian-Rebuild"},body:typeof e=="string"?e:JSON.stringify(e)}}function b(t,e){let n=t.headers||{};return n[e]??n[e.toLowerCase()]}function K(t){return t.isBase64Encoded?Buffer.from(t.body||"","base64"):typeof t.body=="string"?Buffer.from(t.body,"utf8"):Buffer.from(JSON.stringify(t.body||{}),"utf8")}function L(t,e){if(!t||!E)return!1;let n=Buffer.from("sha256="+h.default.createHmac("sha256",E).update(e).digest("hex"),"utf8"),r=Buffer.from(t,"utf8");return r.length===n.length&&h.default.timingSafeEqual(r,n)}function j(t){let e=Math.max(0,t)/36e5,n=G/1e3*e;return Math.round(n*F)}function v(){let t={"User-Agent":"cloudguardian-bot",Accept:"application/vnd.github+json"};return C&&(t.Authorization=`Bearer ${C}`),t}async function M(t,e){let n=await fetch(`https://api.github.com/repos/${t}/${e}/languages`,{headers:v()});if(!n.ok)return console.warn("languages API failed",t,e,n.status,await n.text()),{};let r=await n.json(),s={};for(let[a,u]of Object.entries(r)){let o=Number(u);Number.isNaN(o)||(s[a]=o)}return s}async function W(t,e){let n=e==="Organization"?`https://api.github.com/orgs/${t}/repos`:`https://api.github.com/users/${t}/repos`,r=[],s=1;for(;;){let a=`${n}?per_page=100&page=${s}`,u=await fetch(a,{headers:v()});if(!u.ok){console.warn("list repos failed",t,e,u.status,await u.text());break}let o=await u.json();if(!o.length)break;for(let i of o)r.push({full_name:i.full_name,private:i.private,archived:i.archived});if(o.length<100)break;s++}return r}async function p(t,e,n){await m.send(new c.UpdateCommand({TableName:y,Key:{pk:t,sk:e},UpdateExpression:"SET #l=:l, #u=:u, #id=:id",ExpressionAttributeNames:{"#l":"languages_bytes","#u":"updated_at","#id":"id"},ExpressionAttributeValues:{":l":n,":u":new Date().toISOString(),":id":t}}))}async function R(t,e){if(!e||Number.isNaN(e))return;let n=new Date().toISOString(),r=N();await m.send(new c.UpdateCommand({TableName:y,Key:{pk:t,sk:"stats#overall"},UpdateExpression:"ADD #cg :g SET #u=:u, #id=:id",ExpressionAttributeNames:{"#cg":"carbon_grams_total","#u":"updated_at","#id":"id"},ExpressionAttributeValues:{":g":e,":u":n,":id":t}})),await m.send(new c.UpdateCommand({TableName:y,Key:{pk:t,sk:`stats#${r}`},UpdateExpression:"ADD #cg :g SET #u=:u, #id=:id",ExpressionAttributeNames:{"#cg":"carbon_grams_day","#u":"updated_at","#id":"id"},ExpressionAttributeValues:{":g":e,":u":n,":id":t}}))}function z(t,e){for(let[n,r]of Object.entries(e))t[n]=(t[n]||0)+(r||0);return t}async function X(t,e,n){let r=[],s=0,a=0;return new Promise((u,o)=>{let i=()=>{if(s>=t.length&&a===0)return u(r);for(;a<e&&s<t.length;){let l=s++;a++,n(t[l]).then(d=>{r[l]=d,a--,i()}).catch(d=>{console.warn("mapWithLimit item failed",d),r[l]=void 0,a--,i()})}};i()})}async function J(t,e){let n=await W(t,e),r=N(),s=await X(n,5,async o=>{if(o.archived)return{repo:o.full_name,langs:{}};let[i,l]=o.full_name.split("/"),d=await M(i,l);return{repo:o.full_name,langs:d}}),a={};for(let o of s){if(!o)continue;let i=`repo#${o.repo}`;await p(i,"stats#overall",o.langs),await p(i,`stats#${r}`,o.langs),z(a,o.langs)}let u=`owner#${t}`;return await p(u,"stats#overall",a),await p(u,`stats#${r}`,a),{repoCount:n.length,langKeys:Object.keys(a).length}}async function V(t,e,n){await m.send(new c.PutCommand({TableName:I,Item:{pk:e,sk:t,type:"event",payload:n,received_at:new Date().toISOString()}}))}var q=async t=>{try{if(t.requestContext?.http?.method==="OPTIONS")return g(200,{ok:!0});let e=K(t),n=b(t,"X-Hub-Signature-256"),r=b(t,"X-GitHub-Event")||"",s=b(t,"X-CloudGuardian-Rebuild");if(!L(n,e))return g(401,{error:"invalid signature"});let a=JSON.parse(e.toString("utf8"));if(r==="ping")return g(200,{pong:!0});let u=a.repository||{},o=u.full_name||"unknown/unknown",i=u.owner?.login||o.split("/")[0]||"unknown",l=u.owner?.type==="Organization"?"Organization":"User",d=s==="all"||r==="push"||r==="repository"||r==="workflow_run",_;if(d&&(_=await J(i,l)),r==="workflow_run"){let O=a.workflow_run||{},w=j(Number(O.run_duration_ms??0));await R(`repo#${o}`,w),await R(`owner#${i}`,w),await V(`workflow#${O.id??Date.now()}`,o,{ownerLogin:i,grams:w})}return g(200,{ok:!0,owner:i,evt:r,refreshed:_})}catch(e){return console.error("handler error",e),g(500,{error:"internal",message:e?.message||"unknown"})}};0&&(module.exports={handler});
