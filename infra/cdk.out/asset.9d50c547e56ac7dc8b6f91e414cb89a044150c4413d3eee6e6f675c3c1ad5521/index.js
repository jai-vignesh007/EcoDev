"use strict";var I=Object.create;var y=Object.defineProperty;var G=Object.getOwnPropertyDescriptor;var R=Object.getOwnPropertyNames;var U=Object.getPrototypeOf,$=Object.prototype.hasOwnProperty;var K=(e,t)=>{for(var n in t)y(e,n,{get:t[n],enumerable:!0})},S=(e,t,n,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let a of R(t))!$.call(e,a)&&a!==n&&y(e,a,{get:()=>t[a],enumerable:!(r=G(t,a))||r.enumerable});return e};var L=(e,t,n)=>(n=e!=null?I(U(e)):{},S(t||!e||!e.__esModule?y(n,"default",{value:e,enumerable:!0}):n,e)),M=e=>S(y({},"__esModule",{value:!0}),e);var J={};K(J,{handler:()=>F});module.exports=M(J);var v=require("@aws-sdk/client-dynamodb"),c=require("@aws-sdk/lib-dynamodb"),T=L(require("crypto")),b=c.DynamoDBDocumentClient.from(new v.DynamoDBClient({})),C=process.env.COMMITS_TABLE,_=process.env.REPOINFO_TABLE,N=process.env.GITHUB_WEBHOOK_SECRET||"",O=process.env.GITHUB_ACCESS_TOKEN||"",P=Number(process.env.CF_WATTS??65),j=Number(process.env.CF_G_PER_KWH??400);function g(e,t){return{statusCode:e,headers:{"Content-Type":"application/json","Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"POST,OPTIONS","Access-Control-Allow-Headers":"Content-Type,X-GitHub-Event,X-Hub-Signature-256,X-GitHub-Delivery,X-CloudGuardian-Demo"},body:typeof t=="string"?t:JSON.stringify(t)}}function w(e,t){let n=e.headers||{};return n[t]??n[t.toLowerCase()]}function X(e){return e.isBase64Encoded?Buffer.from(e.body||"","base64"):typeof e.body=="string"?Buffer.from(e.body,"utf8"):Buffer.from(JSON.stringify(e.body||{}),"utf8")}function W(e,t){if(!e||!N)return!1;let n=Buffer.from("sha256="+T.default.createHmac("sha256",N).update(t).digest("hex"),"utf8"),r=Buffer.from(e,"utf8");return r.length===n.length&&T.default.timingSafeEqual(r,n)}function x(e=new Date){let t=n=>String(n).padStart(2,"0");return`${e.getUTCFullYear()}-${t(e.getUTCMonth()+1)}-${t(e.getUTCDate())}`}function V(e){let t=Math.max(0,e)/36e5,n=P/1e3*t;return Math.round(n*j)}async function A(e,t){let n=`https://api.github.com/repos/${e}/${t}/languages`,r={"User-Agent":"cloudguardian-bot",Accept:"application/vnd.github+json"};O&&(r.Authorization=`Bearer ${O}`);let a=await fetch(n,{headers:r});if(!a.ok){let s=await a.text();return console.warn("languages API failed",a.status,s),{map:{},error:`languages api ${a.status}`}}let p=await a.json(),o={};for(let[s,i]of Object.entries(p)){let f=Number(i);Number.isNaN(f)||(o[s]=f)}return{map:o,error:""}}async function m(e,t,n){let r=new Date().toISOString(),a=x(),p={"#l":"languages_bytes","#u":"updated_at","#r":"repo","#e":"languages_error"},o={":l":t,":u":r,":r":e,":e":n||""};await b.send(new c.UpdateCommand({TableName:_,Key:{pk:e,sk:"stats#overall"},UpdateExpression:"SET #r=:r, #u=:u, #l=:l, #e=:e",ExpressionAttributeNames:p,ExpressionAttributeValues:o})),await b.send(new c.UpdateCommand({TableName:_,Key:{pk:e,sk:`stats#${a}`},UpdateExpression:"SET #r=:r, #u=:u, #l=:l, #e=:e",ExpressionAttributeNames:p,ExpressionAttributeValues:o}))}async function B(e,t){if(!t||Number.isNaN(t))return;let n=x(),r=new Date().toISOString();await b.send(new c.UpdateCommand({TableName:_,Key:{pk:e,sk:"stats#overall"},UpdateExpression:"ADD #c :g SET #u=:u, #r=:r",ExpressionAttributeNames:{"#c":"carbon_grams_total","#u":"updated_at","#r":"repo"},ExpressionAttributeValues:{":g":t,":u":r,":r":e}})),await b.send(new c.UpdateCommand({TableName:_,Key:{pk:e,sk:`stats#${n}`},UpdateExpression:"ADD #c :g SET #u=:u, #r=:r",ExpressionAttributeNames:{"#c":"carbon_grams_day","#u":"updated_at","#r":"repo"},ExpressionAttributeValues:{":g":t,":u":r,":r":e}}))}async function D(e,t,n,r){await b.send(new c.PutCommand({TableName:e,Item:{pk:t,sk:n,type:"event",payload:r,received_at:new Date().toISOString()}}))}var F=async e=>{try{if(e.requestContext?.http?.method==="OPTIONS")return g(200,{ok:!0});let t=X(e),n=w(e,"X-Hub-Signature-256"),r=w(e,"X-GitHub-Event")||"",a=w(e,"X-GitHub-Delivery")||"",p=w(e,"X-CloudGuardian-Demo");if(!W(n,t))return g(401,{error:"invalid signature"});let o=JSON.parse(t.toString("utf8"));if(r==="ping")return g(200,{pong:!0});if(p==="languages"){let l=(o.repository||{}).full_name||"demo/repo";return await m(l,{TypeScript:123456,Python:45678,HTML:9e3}),await B(l,3210),g(200,{ok:!0,demo_seeded:!0})}let s=o.repository||{},i=s.full_name||"unknown/unknown",[f,h]=i.split("/");if(r==="push"){let{map:u,error:l}=await A(f,h);if(Object.keys(u).length===0){let d=typeof s.language=="string"&&s.language.trim()?s.language:"";await m(i,d?{[d]:1}:{},l||(d?"fallback-single":"empty"))}else await m(i,u);return await D(C,i,`push#${Date.now()}`,{delivery:a,head:o.head_commit?.id}),g(200,{ok:!0,languages_keys:Object.keys(u).length})}if(r==="workflow_run"){let u=o.workflow_run||{},l=Number(u.run_duration_ms??0),d=V(l);await B(i,d);let{map:k,error:H}=await A(f,h);if(Object.keys(k).length===0){let E=typeof s.language=="string"&&s.language.trim()?s.language:"";await m(i,E?{[E]:1}:{},H||(E?"fallback-single":"empty"))}else await m(i,k);return await D(C,i,`workflow#${u.id??Date.now()}`,{delivery:a,event:u.event,status:u.status,duration_ms:l,carbon_grams:d}),g(200,{ok:!0,carbon_grams_added:d})}return g(200,{ok:!0,ignored_event:r})}catch(t){return console.error("error",t),g(500,{error:"internal",message:t?.message||"unknown"})}};0&&(module.exports={handler});
